# DX3 Development Docker Compose Configuration
# Optimized for development with healthchecks, proper networking, and resource management
#
# MODES:
#   Standalone (default): docker compose up -d
#     - Starts all services including local Redis (6379) and PostgreSQL (5433)
#     - Use when developing this app in isolation
#
#   Integration Mode: make dev-integration
#     - Starts only API + SendGrid + LocalStack (no local Redis/PostgreSQL)
#     - Connects to ax-infrastructure: Redis (6380), TimescaleDB (5434), PostgreSQL (5435)
#     - Requires ax-infrastructure running first: cd ~/Developer/ArteFX/ax-infrastructure ; make up
#
#   BOTH can run simultaneously (no port conflicts):
#     - Local Redis: 6379 | ax-infrastructure Redis: 6380
#     - Local PostgreSQL: 5433 | ax-infrastructure PostgreSQL: 5435 | TimescaleDB: 5434

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    container_name: "redis-dx3"
    networks:
      - dx3-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:16-alpine
    volumes:
      - "db-data:/var/lib/postgresql/data/pgdata"
    environment:
      PGDATA: "/var/lib/postgresql/data/pgdata"
      POSTGRES_USER: "pguser"
      POSTGRES_PASSWORD: "password"
      POSTGRES_DB: "app"
    ports:
      - "5433:5432"
    container_name: "postgres-dx3"
    networks:
      - dx3-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pguser -d app"]
      interval: 5s
      timeout: 5s
      retries: 5

  sendgrid:
    image: ghashange/sendgrid-mock:1.7.2
    container_name: "sendgrid-dx3"
    ports:
      - "7070:3000"
    environment:
      - API_KEY=${SENDGRID_MOCK_API_KEY}
    networks:
      - dx3-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  api-node-22-dx3:
    extends:
      file: ./docker-compose.base.yml
      service: base
    container_name: "api-dx3"
    tty: true
    stdin_open: true
    build:
      context: .
      dockerfile: ./_devops/docker/Dockerfile.local
    volumes:
      # Named volume for node_modules (persists between runs, faster restarts)
      - api-node-modules:/app/node_modules
      # Mount only the source code, not the entire project directory.
      # This ensures the node_modules from the named volume is used.
      - ./packages/api:/app/packages/api
      - ./packages/shared:/app/packages/shared
      - ./_devops/scripts:/app/_devops/scripts
      - ./jest.config.ts:/app/jest.config.ts
      - ./jest.preset.js:/app/jest.preset.js
      - ./biome.json:/app/biome.json
      - ./tsconfig.base.json:/app/tsconfig.base.json
      - ./package.json:/app/package.json
      # NOTE: pnpm-lock.yaml is NOT mounted to avoid EBUSY errors
      # The lockfile is copied during Docker build instead
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
    ports:
      - "4000:4000"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      sendgrid:
        condition: service_healthy
    environment:
      - ROOT_DIR=/app
      # Database connections - overridable via .env.integration for integration mode
      # Standalone defaults: local containers (redis-dx3, postgres-dx3)
      # Integration mode: ax-infrastructure services (host.docker.internal)
      - REDIS_URL=${REDIS_URL:-redis://redis-dx3}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - POSTGRES_URI=${POSTGRES_URI:-postgres://pguser:password@postgres:5432/dx-app}
      # TimescaleDB (logging/metrics) - only enabled in integration mode
      - TIMESCALE_ENABLED=${TIMESCALE_ENABLED:-false}
      - TIMESCALE_URI=${TIMESCALE_URI:-}
      # App identity
      - APP_ID=${APP_ID:-dx3-default}
    networks:
      - dx3-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack
    ports:
      - "4566:4566"            # LocalStack Gateway
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=${DEBUG:-1}
      - SERVICES=s3
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}
      - DOCKER_HOST=${DOCKER_HOST}
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - dx3-network
    healthcheck:
      test: ["CMD-SHELL", "awslocal s3 ls || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

secrets:
  npmrc:
    file: $HOME/.npmrc
  gitconfig:
    file: $HOME/.gitconfig

networks:
  dx3-network:
    driver: bridge
    name: dx3-network

volumes:
  db-data:
  api-node-modules:
    name: dx3-api-node-modules
