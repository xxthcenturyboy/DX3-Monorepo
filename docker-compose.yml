services:
  redis:
      image: redis:7-alpine
      ports:
          - "6379:6379"
      container_name: "redis-dx3"
  postgres:
      image: postgres:16-alpine
      volumes:
        - "db-data:/var/lib/postgresql/data/pgdata"
      environment:
          PGDATA: "/var/lib/postgresql/data/pgdata"
          POSTGRES_USER: "pguser"
          POSTGRES_PASSWORD: "password"
          POSTGRES_DB: "app"
      ports:
          - "5433:5432"
      container_name: "postgres-dx3"
  sendgrid:
    image: ghashange/sendgrid-mock:1.7.2
    container_name: 'sendgrid-dx3'
    ports:
      - '7070:3000'
    environment:
      - API_KEY=${SENDGRID_MOCK_API_KEY}
  api-node-22-dx3:
    extends:
        file: ./docker-compose.base.yml
        service: base
    container_name: 'api-dx3'
    tty: true
    stdin_open: true
    build:
      context: .
      dockerfile: ./_devops/docker/Dockerfile.local
    volumes:
        # Mount only the source code, not the entire project directory.
        # This ensures the node_modules from the image is used.
        - ./packages/api:/app/packages/api
        - ./packages/shared:/app/packages/shared
        - ./jest.config.ts:/app/jest.config.ts
        - ./jest.preset.js:/app/jest.preset.js
        - ./biome.json:/app/biome.json
        - ./tsconfig.base.json:/app/tsconfig.base.json
        - ./package.json:/app/package.json
        # NOTE: pnpm-lock.yaml is NOT mounted to avoid EBUSY errors
        # The lockfile is copied during Docker build instead
        # - ./pnpm-lock.yaml:/app/pnpm-lock.yaml
        - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml
        # - ./packages/api/src/api-app/.env:/app/.env  # Mount .env file for development
        # Prevent host's node_modules from overwriting container's
        - /app/node_modules
        # API packages
        - /app/packages/api/src/api-app/node_modules
        - /app/packages/api/src/api-app-e2e/node_modules
        # Shared packages
        - /app/packages/shared/encryption/node_modules
        - /app/packages/shared/models/node_modules
        - /app/packages/shared/test-data/node_modules
        - /app/packages/shared/utils-shared/node_modules
    ports:
        - "4000:4000"
    depends_on:
        - redis
        - postgres
        - sendgrid
    links:
        - redis
        - postgres
        - sendgrid
    environment:
        - ROOT_DIR=/app
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack
    ports:
      - "4566:4566"            # LocalStack Gateway
      # - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=${DEBUG:-1}
      - SERVICES=s3
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}
      - DOCKER_HOST=${DOCKER_HOST}
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
secrets:
  npmrc:
    file: $HOME/.npmrc
  gitconfig:
    file: $HOME/.gitconfig
volumes:
  db-data:
